define(["libs/bbi/spans","libs/bbi/bin","libs/bbi/jszlib"],function(a,b,c){"use strict";function d(){}function e(a){a&&(this.id=a)}function f(a){var b={};for(var c in a)b[c]=a[c];return b}function g(a,b){var c=a[b]+a[b+1]*y+a[b+2]*z+a[b+3]*A+a[b+4]*B;return c}function h(){}function i(a,b,c,d){this.bwg=a,this.cirTreeOffset=b,this.cirTreeLength=c,this.isSummary=d}function j(a,b,c){var d=new h;d.data=a,d.name=c,d.data.slice(0,512).salted().fetch(function(a){if(!a)return b(null,"Couldn't fetch file");var c=a,e=new Uint8Array(c),f=new Int16Array(c),h=new Int32Array(c),i=e[0]+y*e[1]+z*e[2]+A*e[3];if(i==r)d.type="bigwig";else{if(i!=t)return i==s||i==u?b(null,"Currently don't support big-endian BBI files"):b(null,"Not a supported format, magic=0x"+i.toString(16));d.type="bigbed"}d.version=f[2],d.numZoomLevels=f[3],d.chromTreeOffset=g(e,8),d.unzoomedDataOffset=g(e,16),d.unzoomedIndexOffset=g(e,24),d.fieldCount=f[16],d.definedFieldCount=f[17],d.asOffset=g(e,36),d.totalSummaryOffset=g(e,44),d.uncompressBufSize=h[13],d.extHeaderOffset=g(e,56),d.zoomLevels=[];for(var j=0;j<d.numZoomLevels;++j){var k=h[6*j+16],l=g(e,24*j+72),m=g(e,24*j+80);d.zoomLevels.push({reduction:k,dataOffset:l,indexOffset:m})}d.readChromTree(function(){d.getAutoSQL(function(a){return d.schema=a,b(d)})})},{timeout:5e3})}function k(a,b,c,d,e){this.bbi=a,this.type=b,this.fieldCount=c,this.offset=d,this.field=e}var l=a.Range,m=a.union,n=a.intersection,o=b.readInt,p=c.inflateBuffer,q=c.arrayCopy,r=2291137574,s=654086024,t=2273964779,u=3958540679,v=1,w=2,x=3,y=256,z=65536,A=16777216,B=4294967296,C=new RegExp("^[0-9]+,[0-9]+,[0-9]+");return h.prototype.readChromTree=function(a){var b=this;this.chromsToIDs={},this.idsToChroms={},this.maxID=0;var c=this.unzoomedDataOffset,d=c-this.chromTreeOffset&3;c=c+4-d,this.data.slice(this.chromTreeOffset,c-this.chromTreeOffset).fetch(function(c){var d=new Uint8Array(c),e=new Int16Array(c),f=new Int32Array(c),h=(f[0],f[1],f[2]),i=(f[3],g(d,16),32),j=function(a){var c=d[a],f=e[a/2+1];a+=4;for(var i=0;f>i;++i)if(0==c){a+=h;var k=g(d,a);a+=8,k-=b.chromTreeOffset,j(k)}else{for(var l="",m=0;h>m;++m){var n=d[a++];0!=n&&(l+=String.fromCharCode(n))}{var o=d[a+3]<<24|d[a+2]<<16|d[a+1]<<8|d[a+0];d[a+7]<<24|d[a+6]<<16|d[a+5]<<8|d[a+4]}a+=8,b.chromsToIDs[l]=o,0==l.indexOf("chr")&&(b.chromsToIDs[l.substr(3)]=o),b.idsToChroms[o]=l,b.maxID=Math.max(b.maxID,o)}};j(i),a(b)})},i.prototype.readWigData=function(a,b,c,d){var e=this.bwg.chromsToIDs[a];return void 0===e?d([]):void this.readWigDataById(e,b,c,d)},i.prototype.readWigDataById=function(a,b,c,d){var e=this;if(!this.cirHeader)return void this.bwg.data.slice(this.cirTreeOffset,48).fetch(function(f){e.cirHeader=f;var g=new Int32Array(e.cirHeader);e.cirBlockSize=g[1],e.readWigDataById(a,b,c,d)});var f=[],h=0,i=(Date.now(),function(d,e,f){return(0>a||d==a)&&c>=e&&f>=b}),j=function(a,b){if(e.bwg.instrument&&console.log("level="+b+"; offset="+a+"; time="+(0|Date.now())),h+=a.length,1==a.length&&a[0]-e.cirTreeOffset==48&&e.cachedCirRoot)return n(e.cachedCirRoot,0,b),--h,void(0==h&&e.fetchFeatures(i,f,d));for(var c,g=4+32*e.cirBlockSize,j=0;j<a.length;++j){var o=new l(a[j],a[j]+g);c=c?m(c,o):o}for(var p=c.ranges(),q=0;q<p.length;++q){var r=p[q];k(a,r,b)}},k=function(a,b,c){b.max()-b.min();e.bwg.data.slice(b.min(),b.max()-b.min()).fetch(function(g){for(var j=0;j<a.length;++j)b.contains(a[j])&&(n(g,a[j]-b.min(),c),a[j]-e.cirTreeOffset==48&&a[j]-b.min()==0&&(e.cachedCirRoot=g),--h,0==h&&e.fetchFeatures(i,f,d))})},n=function(d,e,h){var i=new Uint8Array(d),k=new Int16Array(d),l=new Int32Array(d),m=i[e],n=k[e/2+1];if(e+=4,0!=m)for(var o=0;n>o;++o){var p=e/4,q=l[p],r=l[p+1],s=l[p+2],t=l[p+3],u=g(i,e+16),v=g(i,e+24);(0>a||a>q||q==a&&c>=r)&&(0>a||s>a||s==a&&t>=b)&&f.push({offset:u,size:v}),e+=32}else{for(var w=[],o=0;n>o;++o){var p=e/4,q=l[p],r=l[p+1],s=l[p+2],t=l[p+3],u=g(i,e+16);(0>a||a>q||q==a&&c>=r)&&(0>a||s>a||s==a&&t>=b)&&w.push(u),e+=24}w.length>0&&j(w,h+1)}};j([e.cirTreeOffset+48],1)},i.prototype.fetchFeatures=function(a,b,c){var e=this;if(b.sort(function(a,b){return(0|a.offset)-(0|b.offset)}),0==b.length)c([]);else{var f=[],g=function(a,b,c,g){g||(g={});var h=new d;h._chromId=a,h.segment=e.bwg.idsToChroms[a],h.min=b,h.max=c,h.type=e.bwg.type;for(var i in g)h[i]=g[i];f.push(h)},h=function(){if(0==b.length){{Date.now()}return void c(f)}var d=b[0];if(d.data)e.parseFeatures(d.data,g,a),b.splice(0,1),h();else{for(var i=d.offset,j=d.size,k=1;k<b.length&&b[k].offset==i+j;)j+=b[k].size,++k;e.bwg.data.slice(i,j).fetch(function(a){for(var c=0,d=0;j>c;){var f,g=b[d];if(e.bwg.uncompressBufSize>0)f=p(a,c+2,g.size-2);else{var i=new Uint8Array(g.size);q(new Uint8Array(a,c,g.size),0,i,0,g.size),f=i.buffer}g.data=f,c+=g.size,++d}h()})}};h()}},i.prototype.parseFeatures=function(a,b,c){var d=new Uint8Array(a);if(this.isSummary)for(var g=new Int16Array(a),h=new Int32Array(a),i=new Float32Array(a),j=a.byteLength/32,k=0;j>k;++k){{var o=h[8*k],p=h[8*k+1],q=h[8*k+2],r=h[8*k+3],s=(i[8*k+4],i[8*k+5]),t=i[8*k+6];i[8*k+7]}if(c(o,p+1,q)){var u={type:"bigwig",score:t/r,maxScore:s};"bigbed"==this.bwg.type&&(u.type="density"),b(o,p+1,q,u)}}else if("bigwig"==this.bwg.type){var g=new Int16Array(a),h=new Int32Array(a),i=new Float32Array(a),o=h[0],y=h[1],z=(h[2],h[3]),A=h[4],B=d[20],j=g[11];if(B==x)for(var k=0;j>k;++k){var D=i[k+6],E=y+k*z+1,F=y+k*z+A;c(o,E,F)&&b(o,E,F,{score:D})}else if(B==w)for(var k=0;j>k;++k){var p=h[2*k+6]+1,q=p+A-1,D=i[2*k+7];c(o,p,q)&&b(o,p,q,{score:D})}else if(B==v)for(var k=0;j>k;++k){var p=h[3*k+6]+1,q=h[3*k+7],D=i[3*k+8];p>q&&(p=q),c(o,p,q)&&b(o,p,q,{score:D})}else console.log("Currently not handling bwgType="+B)}else{if("bigbed"!=this.bwg.type)throw Error("Don't know what to do with "+this.bwg.type);for(var G=0,H=this.bwg.definedFieldCount,I=this.bwg.schema;G<d.length;){var o=d[G+3]<<24|d[G+2]<<16|d[G+1]<<8|d[G+0],p=d[G+7]<<24|d[G+6]<<16|d[G+5]<<8|d[G+4],q=d[G+11]<<24|d[G+10]<<16|d[G+9]<<8|d[G+8];G+=12;for(var J="";;){var K=d[G++];if(0==K)break;J+=String.fromCharCode(K)}var L,M={};if(L=J.length>0?J.split("	"):[],L.length>0&&H>3&&(M.label=L[0]),L.length>1&&H>4){var D=parseInt(L[1]);isNaN(D)||(M.score=D)}if(L.length>2&&H>5&&(M.orientation=L[2]),L.length>5&&H>8){var N=L[5];C.test(N)&&(M.itemRgb="rgb("+N+")")}if(L.length>H-3&&I)for(var O=H-3;O<L.length;++O)M[I.fields[O+3].name]=L[O];if(c(o,p+1,q,L))if(12>H)b(o,p+1,q,M);else{var P=0|L[3],Q=0|L[4],R=0|L[6],S=L[7].split(","),T=L[8].split(",");if(M.exonFrames){var U=M.exonFrames.split(",");M.exonFrames=void 0}M.type="transcript";var V=new e;for(var W in M)V[W]=M[W];if(V.id=L[0],V.segment=this.bwg.idsToChroms[o],V.min=p+1,V.max=q,V.notes=[],M.groups=[V],L.length>9){var X=M.geneName||L[9],Y=X;L.length>10&&(Y=L[10]),M.geneName2&&(Y=M.geneName2);var Z=f(V);Z.id=X,Z.label=Y,Z.type="gene",M.groups.push(Z)}for(var $=[],_=0;R>_;++_){var aa=(0|T[_])+p,ba=aa+(0|S[_]),ca=new l(aa,ba);$.push(ca)}for(var da=m($),ea=da.ranges(),fa=0;fa<ea.length;++fa){var ga=ea[fa];b(o,ga.min()+1,ga.max(),M)}if(Q>P){var ha="+"==M.orientation?new l(P,Q+3):new l(P-3,Q),ia=n(da,ha);if(ia){M.type="translation";for(var ja=ia.ranges(),ka=0,la=0;ja[0].min()>ea[la].max();)la++;for(var fa=0;fa<ja.length;++fa){var ma=fa;"-"==M.orientation&&(ma=ja.length-fa-1);var ga=ja[ma];if(M.readframe=ka,U){var na=parseInt(U[ma+la]);"number"==typeof na&&na>=0&&2>=na&&(M.readframe=na,M.readframeExplicit=!0)}var oa=ga.max()-ga.min();ka=(ka+oa)%3,b(o,ga.min()+1,ga.max(),M)}}}}}}},i.prototype.getFirstAdjacent=function(a,b,c,d){var e=this.bwg.chromsToIDs[a];return void 0===e?d([]):void this.getFirstAdjacentById(e,b,c,d)},i.prototype.getFirstAdjacentById=function(a,b,c,d){var e=this;if(!this.cirHeader)return void this.bwg.data.slice(this.cirTreeOffset,48).fetch(function(f){e.cirHeader=f;var g=new Int32Array(e.cirHeader);e.cirBlockSize=g[1],e.getFirstAdjacentById(a,b,c,d)});var f=null,h=-1,i=-1,j=0,k=(Date.now(),function(a,b){j+=a.length;for(var c,d=4+32*e.cirBlockSize,f=0;f<a.length;++f){var g=new l(a[f],a[f]+d);c=c?m(c,g):g}for(var h=c.ranges(),i=0;i<h.length;++i){var k=h[i];n(a,k,b)}}),n=function(g,h,i){h.max()-h.min();e.bwg.data.slice(h.min(),h.max()-h.min()).fetch(function(k){for(var l=0;l<g.length;++l)if(h.contains(g[l])&&(o(k,g[l]-h.min(),i),--j,0==j)){if(!f)return c>0&&(0!=a||b>0)?e.getFirstAdjacentById(0,0,c,d):0>c&&(a!=e.bwg.maxID||1e9>b)?e.getFirstAdjacentById(e.bwg.maxID,1e9,c,d):d([]);e.fetchFeatures(function(d,e,f){return 0>c&&(a>d||b>f)||c>0&&(d>a||e>b)},[f],function(a){for(var b=null,e=-1,f=-1,g=0;g<a.length;++g){var h=a[g],i=h._chromId,j=h.min,k=h.max;(null==b||0>c&&(i>e||k>f)||c>0&&(e>i||f>j))&&(b=h,f=0>c?k:j,e=i)}return d(null!=b?[b]:[])})}})},o=function(d,j,l){var m=new Uint8Array(d),n=new Int16Array(d),o=new Int32Array(d),p=m[j],q=n[j/2+1];if(j+=4,0!=p)for(var r=0;q>r;++r){var s=j/4,t=o[s],u=o[s+1],v=o[s+2],w=o[s+3],x=g(m,j+16),y=g(m,j+24);(0>c&&(a>t||t==a&&b>=u)||c>0&&(v>a||v==a&&w>=b))&&(/_random/.exec(e.bwg.idsToChroms[t])||(null==f||0>c&&(v>h||v==h&&w>i)||c>0&&(h>t||t==h&&i>u))&&(f={offset:x,size:y},i=0>c?w:u,h=0>c?v:t)),j+=32}else{for(var z=-1,A=-1,B=-1,r=0;q>r;++r){var s=j/4,t=o[s],u=o[s+1],v=o[s+2],w=o[s+3],x=o[s+4]<<32|o[s+5];(0>c&&(a>t||t==a&&b>=u)&&v>=a||c>0&&(v>a||v==a&&w>=b)&&a>=t)&&(0>z||w>A)&&(z=x,A=0>c?w:u,B=0>c?v:t),j+=24}z>=0&&k([z],l+1)}};k([e.cirTreeOffset+48],1)},h.prototype.readWigData=function(a,b,c,d){this.getUnzoomedView().readWigData(a,b,c,d)},h.prototype.getUnzoomedView=function(){if(!this.unzoomedView){var a=4e3,b=this.zoomLevels[0];b&&(a=this.zoomLevels[0].dataOffset-this.unzoomedIndexOffset),this.unzoomedView=new i(this,this.unzoomedIndexOffset,a,!1)}return this.unzoomedView},h.prototype.getZoomedView=function(a){var b=this.zoomLevels[a];return b.view||(b.view=new i(this,b.indexOffset,4e3,!0)),b.view},h.prototype._tsFetch=function(a,b,c,d,e){var f=this;if(!(a>=this.zoomLevels.length-1)){var g;return g=0>a?this.getUnzoomedView():this.getZoomedView(a),g.readWigDataById(b,c,d,e)}if(this.topLevelReductionCache){for(var h=[],i=this.topLevelReductionCache,j=0;j<i.length;++j)i[j]._chromId==b&&h.push(i[j]);return e(h)}this.getZoomedView(this.zoomLevels.length-1).readWigDataById(-1,0,3e8,function(g){return f.topLevelReductionCache=g,f._tsFetch(a,b,c,d,e)})},h.prototype.thresholdSearch=function(a,b,c,d,e){function f(){if(0==i.length)return e(null);i.sort(function(a,b){var d=a.zoom-b.zoom;return 0!=d?d:(d=a.chrOrd-b.chrOrd,0!=d?d:a.min-b.min*c)});var a=i.splice(0,1)[0];g._tsFetch(a.zoom,a.chr,a.min,a.max,function(g){var h=c>0?0:3e8;a.fromRef&&(h=b);for(var j=0;j<g.length;++j){var k,l=g[j];if(k=void 0!=l.maxScore?l.maxScore:l.score,c>0){if(k>d)if(a.zoom<0){if(l.min>h)return e(l)}else l.max>h&&i.push({chr:a.chr,chrOrd:a.chrOrd,zoom:a.zoom-2,min:l.min,max:l.max,fromRef:a.fromRef})}else if(k>d)if(a.zoom<0){if(l.max<h)return e(l)}else l.min<h&&i.push({chr:a.chr,chrOrd:a.chrOrd,zoom:a.zoom-2,min:l.min,max:l.max,fromRef:a.fromRef})}f()})}c=0>c?-1:1;for(var g=this,h=this.chromsToIDs[a],i=[{chrOrd:0,chr:h,zoom:g.zoomLevels.length-4,min:0,max:3e8,fromRef:!0}],j=1;j<=this.maxID+1;++j){var k=(h+c*j)%(this.maxID+1);0>k&&(k+=this.maxID+1),i.push({chrOrd:j,chr:k,zoom:g.zoomLevels.length-1,min:0,max:3e8})}f()},h.prototype.getAutoSQL=function(a){return this.asOffset?void this.data.slice(this.asOffset,2048).fetch(function(b){for(var c=new Uint8Array(b),d="",e=0;e<c.length&&0!=c[e];++e)d+=String.fromCharCode(c[e]);var f=/(\w+)\s+(\w+)\s+("([^"]+)")?\s+\(\s*/,g=/([\w\[\]]+)\s+(\w+)\s*;\s*("([^"]+)")?\s*/g,h=f.exec(d);if(h){var i={declType:h[1],name:h[2],comment:h[4],fields:[]};d=d.substring(h[0]);for(var j=g.exec(d);null!=j;j=g.exec(d))i.fields.push({type:j[1],name:j[2],comment:j[4]});return a(i)}}):a(null)},h.prototype.getExtraIndices=function(a){var b=this;return this.version<4||0==this.extHeaderOffset||"bigbed"!=this.type?a(null):void this.data.slice(this.extHeaderOffset,64).fetch(function(c){if(!c)return a(null,"Couldn't fetch extension header");var d=new Uint8Array(c),e=new Int16Array(c),f=(new Int32Array(c),e[0],e[1]),h=g(d,4);return 0==f?a(null):void b.data.slice(h,20*f).fetch(function(c){if(!c)return a(null,"Couldn't fetch index info");for(var d=new Uint8Array(c),e=new Int16Array(c),h=(new Int32Array(c),[]),i=0;f>i;++i){var j=e[10*i],l=e[10*i+1],m=g(d,20*i+4),n=e[10*i+8],o=new k(b,j,l,m,n);h.push(o)}a(h)})})},k.prototype.lookup=function(a,b){var c=this;this.bbi.data.slice(this.offset,32).fetch(function(d){function e(d){c.bbi.data.slice(d,4+i*(j+k)).fetch(function(d){var f=new Uint8Array(d),h=new Uint16Array(d),i=(new Uint32Array(d),f[0]),l=h[1],m=4;if(0!=i){for(var n=0;l>n;++n){for(var p="",q=0;j>q;++q){var r=f[m++];0!=r&&(p+=String.fromCharCode(r))}if(p==a){var s=g(f,m),t=o(f,m+8);return c.bbi.getUnzoomedView().fetchFeatures(function(b,d,e,f){return f&&f.length>c.field-3?f[c.field-3]==a:void 0},[{offset:s,size:t}],b)}m+=k}return b([])}for(var u=null,n=0;l>n;++n){for(var p="",q=0;j>q;++q){var r=f[m++];0!=r&&(p+=String.fromCharCode(r))}var v=g(f,m);if(m+=8,a.localeCompare(p)<0&&u)return void e(u);u=v}e(u)})}var f=new Uint8Array(d),h=(new Int16Array(d),new Int32Array(d)),i=(h[0],h[1]),j=h[2],k=h[3],l=(g(f,16),32);e(c.offset+l)})},{makeBwg:j,BIG_BED_MAGIC:t,BIG_WIG_MAGIC:r}});
//# sourceMappingURL=../../../maps/libs/bbi/bigwig.js.map
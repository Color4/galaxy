define(["libs/bbi/sha1"],function(a){"use strict";function b(a){var b={};for(var c in a)b[c]=a[c];return b}function c(a){this.blob=a}function d(a,b,c,d){d||("object"==typeof b?(d=b,b=void 0):d={}),this.url=a,this.start=b||0,c&&(this.end=c),this.opts=d}function e(a){if(!a)return null;for(var b=new Uint8Array(a.length),c=0;c<b.length;++c)b[c]=a.charCodeAt(c);return b.buffer}function f(a,b){return a[b+7]<<24|a[b+6]<<16|a[b+5]<<8|a[b+4]}function g(a,b){return a[b+3]<<24|a[b+2]<<16|a[b+1]<<8|a[b]}function h(a,b){return a[b+1]<<8|a[b]}function i(a,b){return a[b]}function j(a,b){return a[b]<<24|a[b+1]<<16|a[b+2]<<8|a[b+3]}var k=a.b64_sha1;c.prototype.slice=function(a,b){var d;return d=this.blob.slice?b?this.blob.slice(a,a+b):this.blob.slice(a):b?this.blob.webkitSlice(a,a+b):this.blob.webkitSlice(a),new c(d)},c.prototype.salted=function(){return this},c.prototype.fetch="undefined"!=typeof FileReader?function(a){var b=new FileReader;b.onloadend=function(){a(e(b.result))},b.readAsBinaryString(this.blob)}:function(a){var b=new FileReaderSync;try{var c=b.readAsArrayBuffer(this.blob);a(c)}catch(d){a(null,d)}},d.prototype.slice=function(a,b){if(0>a)throw"Bad slice "+a;var c=this.start,e=this.end;return c&&a?c+=a:c=a||c,e=b&&c?c+b-1:e||b-1,new d(this.url,c,e,this.opts)};var l=0,m=navigator.userAgent.indexOf("Safari")>=0&&navigator.userAgent.indexOf("Chrome")<0;return d.prototype.fetchAsText=function(a){try{var b,c=new XMLHttpRequest,d=this.url;if((m||this.opts.salt)&&d.indexOf("?")<0&&(d=d+"?salt="+k(""+Date.now()+","+ ++l)),c.open("GET",d,!0),this.end){if(this.end-this.start>1e8)throw"Monster fetch!";c.setRequestHeader("Range","bytes="+this.start+"-"+this.end),b=this.end-this.start+1}c.onreadystatechange=function(){return 4==c.readyState?a(200==c.status||206==c.status?c.responseText:null):void 0},this.opts.credentials&&(c.withCredentials=!0),c.send("")}catch(e){return a(null)}},d.prototype.salted=function(){var a=b(this.opts);return a.salt=!0,new d(this.url,this.start,this.end,a)},d.prototype.fetch=function(a,b){var c=this;b=b||{};var d=b.attempt||1,f=b.truncatedLength;if(d>3)return a(null);try{var g;b.timeout&&!this.opts.credentials&&(g=setTimeout(function(){return console.log("timing out "+j),i.abort(),a(null,"Timeout")},b.timeout));var h,i=new XMLHttpRequest,j=this.url;if((m||this.opts.salt)&&j.indexOf("?")<0&&(j=j+"?salt="+k(""+Date.now()+","+ ++l)),i.open("GET",j,!0),i.overrideMimeType("text/plain; charset=x-user-defined"),this.end){if(this.end-this.start>1e8)throw"Monster fetch!";i.setRequestHeader("Range","bytes="+this.start+"-"+this.end),h=this.end-this.start+1}i.responseType="arraybuffer",i.onreadystatechange=function(){if(4==i.readyState){if(g&&clearTimeout(g),200==i.status||206==i.status){if(i.response){var b=i.response.byteLength;return!h||h==b||f&&b==f?a(i.response):c.fetch(a,{attempt:d+1,truncatedLength:b})}if(i.mozResponseArrayBuffer)return a(i.mozResponseArrayBuffer);var j=i.responseText;return!h||h==j.length||f&&j.length==f?a(e(i.responseText)):c.fetch(a,{attempt:d+1,truncatedLength:j.length})}return c.fetch(a,{attempt:d+1})}},this.opts.credentials&&(i.withCredentials=!0),i.send("")}catch(n){return a(null)}},{BlobFetchable:c,URLFetchable:d,readInt:g,readIntBE:j,readInt64:f,readShort:h,readByte:i}});
//# sourceMappingURL=../../../maps/libs/bbi/bin.js.map